{% extends 'base.html' %}

{% block content %}
<style>
  .overdue { background-color: #f8d7da !important; }
  .iit-approaching { background-color: #fff3cd !important; } /* yellow */
  .cards-container { display: flex; flex-direction: column; gap: 1rem; }
  .refill-card { padding: 1rem; }
  .refill-card small { display: block; margin-bottom: 0.5rem; }
</style>

<!-- ================= FILTERS ================= -->
<form method="get" class="mb-3 d-flex gap-2 align-items-center">
  <select name="facility" onchange="this.form.submit()" class="form-select w-auto">
    <option value="">All Facilities</option>
    {% for facility in facilities %}
      <option value="{{ facility.id }}" {% if facility.id|stringformat:"s" == selected_facility %} selected {% endif %}>
        {{ facility.name }}
      </option>
    {% endfor %}
  </select>

  <select name="case_manager" onchange="this.form.submit()" class="form-select w-auto">
    <option value="">All Case Managers</option>
    {% for manager in case_managers %}
      <option value="{{ manager }}" {% if manager == selected_case_manager %} selected {% endif %}>
        {{ manager }}
      </option>
    {% endfor %}
  </select>
</form>

<!-- ================= MOBILE CARDS ================= -->
<div class="d-block d-md-none cards-container">
  {% for period in periods %}
  <div class="card refill-card {% if period.name == 'Daily' %}text-white bg-primary{% elif period.name == 'Weekly' %}text-dark bg-warning{% else %}text-white bg-success{% endif %}">
    <div class="card-body">
      <h5>{{ period.name }} Expected ({{ period.page_obj.paginator.count }})</h5>
      {% for refill in period.page_obj %}
      <small class=" 
        {% if refill.next_appointment and refill.next_appointment < today %}overdue{% elif refill.expected_iit_date and refill.expected_iit_date <= today|add:'7' %}iit-approaching{% endif %}">
        {{ refill.unique_id }} | {{ refill.facility.name }}<br>
        Next: {{ refill.next_appointment|date:"Y-m-d" }} | Regimen: {{ refill.current_regimen }}<br>
        Case Manager: {{ refill.case_manager }}<br>
        Action: 
        {% if refill.missed_appointment %}<span class="badge bg-danger">Missed Appointment</span><br>{% endif %}
        <a href="{% url 'refill_add_with_id' unique_id=refill.unique_id %}" class="btn btn-primary btn-sm">Add Refills</a>
      </small>
      <hr>
      {% empty %}
      <small>No {{ period.name|lower }} expected refills</small>
      {% endfor %}

      <!-- Mobile Pagination (unchanged) -->
      {% if period.page_obj.has_other_pages %}
        <nav aria-label="{{ period.name }} refills pagination">
          <ul class="pagination justify-content-center">
            {% if period.page_obj.has_previous %}
            <li class="page-item">
              <a class="page-link" href="?{{ period.name|lower }}_page={{ period.page_obj.previous_page_number }}&facility={{ selected_facility }}&case_manager={{ selected_case_manager }}" aria-label="Previous">&laquo;</a>
            </li>
            {% else %}
            <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
            {% endif %}
            {% for num in period.page_obj.paginator.page_range %}
              {% if period.page_obj.number == num %}
              <li class="page-item active"><span class="page-link">{{ num }}</span></li>
              {% elif num > period.page_obj.number|add:"-3" and num < period.page_obj.number|add:"3" %}
              <li class="page-item">
                <a class="page-link" href="?{{ period.name|lower }}_page={{ num }}&facility={{ selected_facility }}&case_manager={{ selected_case_manager }}">{{ num }}</a>
              </li>
              {% endif %}
            {% endfor %}
            {% if period.page_obj.has_next %}
            <li class="page-item">
              <a class="page-link" href="?{{ period.name|lower }}_page={{ period.page_obj.next_page_number }}&facility={{ selected_facility }}&case_manager={{ selected_case_manager }}" aria-label="Next">&raquo;</a>
            </li>
            {% else %}
            <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
            {% endif %}
          </ul>
        </nav>
      {% endif %}
    </div>
  </div>
  {% endfor %}
</div>

<!-- ================= DESKTOP TABLES ================= -->
<div class="d-none d-md-block">
  {% for period in periods %}
  <h3>{{ period.name }} Expected</h3>
  <table class="table table-striped table-bordered">
    <thead class="table-dark">
      <tr>
        <th>Unique ID</th>
        <th>Sex</th>
        <th>Facility</th>
        <th>Last Pickup</th>
        <th>Refill (Days)</th>
        <th class="text-danger">Next Appointment</th>
        <th>Regimen</th>
        <th>Case Manager</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody>
      {% for refill in period.page_obj %}
      <tr class=" 
        {% if refill.next_appointment and refill.next_appointment < today %}overdue{% elif refill.next_appointment and refill.next_appointment <= today|add:'7' %}iit-approaching{% endif %}">
        <td>{{ refill.unique_id }}</td>
        <td>{{ refill.sex }}</td>
        <td>{{ refill.facility.name }}</td>
        <td>{{ refill.last_pickup_date|date:"Y-m-d" }}</td>
        <td>{{ refill.months_of_refill_days }}</td>
        <td>{{ refill.next_appointment|date:"Y-m-d" }}</td>
        <td>{{ refill.current_regimen }}</td>
        <td>{{ refill.case_manager }}</td>
        <td>
          {% if refill.missed_appointment %}<span class="badge bg-danger">Missed Appointment</span><br>{% endif %}
          <a href="{% url 'refill_add_with_id' unique_id=refill.unique_id %}" class="btn btn-primary btn-sm">Add Refills</a>
        </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="9" class="text-center">No {{ period.name|lower }} expected refills</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <!-- Desktop Pagination (unchanged) -->
  {% if period.page_obj.has_other_pages %}
    <nav aria-label="{{ period.name }} refills pagination">
      <ul class="pagination justify-content-center">
        {% if period.page_obj.has_previous %}
        <li class="page-item">
          <a class="page-link" href="?{{ period.name|lower }}_page={{ period.page_obj.previous_page_number }}&facility={{ selected_facility }}&case_manager={{ selected_case_manager }}" aria-label="Previous">&laquo;</a>
        </li>
        {% else %}
        <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
        {% endif %}
        {% for num in period.page_obj.paginator.page_range %}
          {% if period.page_obj.number == num %}
          <li class="page-item active"><span class="page-link">{{ num }}</span></li>
          {% elif num > period.page_obj.number|add:"-3" and num < period.page_obj.number|add:"3" %}
          <li class="page-item">
            <a class="page-link" href="?{{ period.name|lower }}_page={{ num }}&facility={{ selected_facility }}&case_manager={{ selected_case_manager }}">{{ num }}</a>
          </li>
          {% endif %}
        {% endfor %}
        {% if period.page_obj.has_next %}
        <li class="page-item">
          <a class="page-link" href="?{{ period.name|lower }}_page={{ period.page_obj.next_page_number }}&facility={{ selected_facility }}&case_manager={{ selected_case_manager }}" aria-label="Next">&raquo;</a>
        </li>
        {% else %}
        <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
        {% endif %}
      </ul>
    </nav>
  {% endif %}
  {% endfor %}
</div>

<br><br>
<a href="{% url 'refill_list' %}?download=true&facility={{ selected_facility }}&case_manager={{ selected_case_manager }}" class="btn btn-success">Download Refills as Excel</a>
<br><br>
{% endblock content %}
