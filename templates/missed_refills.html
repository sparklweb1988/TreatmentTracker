{% extends 'base.html' %}
{% block content %}

<style>
  .overdue { background-color: #f8d7da !important; }
  .iit-approaching { background-color: #fff3cd !important; }
  .cards-container { display: flex; flex-direction: column; gap: 1rem; }
  .refill-card { padding: 1rem; border-radius: 10px; }
</style>

<div class="container mt-4">

  <!-- COUNT HEADER -->
  <div class="mb-3 text-center">
    <h4 class="fw-bold text-danger">
      Total Missed Appointments: {{ total_missed }}
    </h4>
  </div>

  <!-- FILTERS -->
  <form method="get" class="mb-4 row g-2 align-items-center">
    <div class="col-12 col-md-2">
      <input type="text" name="search_unique_id" value="{{ search_unique_id|default:'' }}"
             placeholder="Search Unique ID" class="form-control" />
    </div>

    <div class="col-12 col-md-2">
      <select name="facility" onchange="this.form.submit()" class="form-select">
        <option value="">All Facilities</option>
        {% for facility in facilities %}
          <option value="{{ facility.id }}" {% if facility.id|stringformat:"s" == selected_facility %} selected {% endif %}>
            {{ facility.name }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="col-12 col-md-2">
      <select name="case_manager" onchange="this.form.submit()" class="form-select">
        <option value="">All Case Managers</option>
        {% for manager in case_managers %}
          <option value="{{ manager }}" {% if manager == selected_case_manager %} selected {% endif %}>
            {{ manager }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="col-12 col-md-2">
      <input type="date" name="start_date" value="{{ selected_start_date }}" class="form-control">
    </div>

    <div class="col-12 col-md-2">
      <input type="date" name="end_date" value="{{ selected_end_date }}" class="form-control">
    </div>

    <div class="col-12 col-md-2">
      <button type="submit" class="btn btn-danger w-100">Apply Filters</button>
    </div>
  </form>

  <!-- MOBILE VIEW -->
  <div class="d-block d-md-none cards-container">
    {% for refill in page_obj %}
      <div class="card refill-card shadow 
          {% if refill.days_missed >= 28 %}border-danger
          {% elif refill.days_missed > 7 %}border-warning
          {% else %}border-secondary{% endif %}">

          <div class="card-body">
            <h6 class="fw-bold text-danger">{{ refill.unique_id }}</h6>
            <small><strong>Facility:</strong> {{ refill.facility.name|default:"N/A" }}</small><br>
            <small><strong>Case Manager:</strong> {{ refill.case_manager|default:"Not Assigned" }}</small><br>
            <small><strong>Last Pickup:</strong>
              {% if refill.last_pickup_date %}{{ refill.last_pickup_date|date:"Y-m-d" }}
              {% else %}<span class="text-danger">Never Picked</span>{% endif %}
            </small><br>
            <small><strong>Next Appointment:</strong> {{ refill.next_appointment|date:"Y-m-d" }}</small><br>
            <small><strong>Days Missed:</strong>
              <span class="{% if refill.days_missed >= 28 %}badge bg-danger
                            {% elif refill.days_missed > 7 %}badge bg-warning text-dark
                            {% else %}badge bg-secondary{% endif %}">
                {{ refill.days_missed }} days
              </span>
            </small><br>
            <small><strong>IIT Status:</strong>
              <span class="{% if refill.iit_status == 'IIT' %}badge bg-danger
                            {% elif 'days to IIT' in refill.iit_status %}badge bg-warning text-dark
                            {% else %}badge bg-secondary{% endif %}">
                {{ refill.iit_status }}
              </span>
            </small><br>
            <!-- VL Eligibility Status -->
            <small><strong>VL Status:</strong> {{ refill.vl_status|default:"N/A" }}</small>

            <div class="mt-2">
              <a href="{% url 'refill_add_with_id' unique_id=refill.unique_id %}"
                 class="btn btn-primary btn-sm w-100">Add Refills</a>
            </div>
          </div>
      </div>
    {% empty %}
      <div class="alert alert-success text-center">
        No missed refills ðŸŽ‰
      </div>
    {% endfor %}

    <!-- Pagination (mobile) -->
    <nav aria-label="Page navigation" class="mt-3">
      <ul class="pagination justify-content-center">
        {% if page_obj.has_previous %}
          <li class="page-item">
            <a class="page-link" href="?{{ query_params }}&page={{ page_obj.previous_page_number }}">Previous</a>
          </li>
        {% endif %}
        <li class="page-item disabled">
          <span class="page-link">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
        </li>
        {% if page_obj.has_next %}
          <li class="page-item">
            <a class="page-link" href="?{{ query_params }}&page={{ page_obj.next_page_number }}">Next</a>
          </li>
        {% endif %}
      </ul>
    </nav>
  </div>

  <!-- DESKTOP TABLE -->
  <div class="d-none d-md-block">
    <div class="card shadow">
      <div class="card-body table-responsive">
        <table class="table table-striped table-hover table-bordered align-middle">
          <thead class="table-danger text-center">
            <tr>
              <th>#</th>
              <th>Unique ID</th>
              <th>Facility</th>
              <th>Case Manager</th>
              <th>Last Pickup</th>
              <th>Next Appointment</th>
              <th>Days Missed</th>
              <th>IIT Status</th>
              <th>VL Status</th> <!-- NEW COLUMN -->
              <th>Action</th>
            </tr>
          </thead>

          <tbody>
            {% for refill in page_obj %}
              <tr class="{% if refill.days_missed >= 28 %}overdue
                         {% elif refill.days_missed > 7 %}iit-approaching{% endif %}">
                <td>{{ forloop.counter }}</td>
                <td class="fw-bold text-danger">{{ refill.unique_id }}</td>
                <td>{{ refill.facility.name|default:"N/A" }}</td>
                <td>{{ refill.case_manager|default:"Not Assigned" }}</td>
                <td>{% if refill.last_pickup_date %}{{ refill.last_pickup_date|date:"Y-m-d" }}{% else %}<span class="text-danger">Never Picked</span>{% endif %}</td>
                <td class="fw-bold">{{ refill.next_appointment|date:"Y-m-d" }}</td>
                <td class="text-center">
                  <span class="{% if refill.days_missed >= 28 %}badge bg-danger
                                {% elif refill.days_missed > 7 %}badge bg-warning text-dark
                                {% else %}badge bg-secondary{% endif %}">
                    {{ refill.days_missed }} days
                  </span>
                </td>
                <td class="text-center">
                  <span class="{% if refill.iit_status == 'IIT' %}badge bg-danger
                                {% elif 'days to IIT' in refill.iit_status %}badge bg-warning text-dark
                                {% else %}badge bg-secondary{% endif %}">
                    {{ refill.iit_status }}
                  </span>
                </td>
                <!-- VL Eligibility Status -->
                <td class="text-center">{{ refill.vl_status|default:"N/A" }}</td>
                <td class="text-center">
                  <a href="{% url 'refill_add_with_id' unique_id=refill.unique_id %}" class="btn btn-primary btn-sm">
                     Add Refills
                  </a>
                </td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="10" class="text-center text-success">No missed refills ðŸŽ‰</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>

        <!-- Pagination (desktop) -->
        <nav aria-label="Page navigation" class="mt-3">
          <ul class="pagination justify-content-center">
            {% if page_obj.has_previous %}
              <li class="page-item">
                <a class="page-link" href="?{{ query_params }}&page={{ page_obj.previous_page_number }}">Previous</a>
              </li>
            {% endif %}
            <li class="page-item disabled"><span class="page-link">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span></li>
            {% if page_obj.has_next %}
              <li class="page-item">
                <a class="page-link" href="?{{ query_params }}&page={{ page_obj.next_page_number }}">Next</a>
              </li>
            {% endif %}
          </ul>
        </nav>

      </div>
    </div>
  </div>

  <!-- DOWNLOAD BUTTON -->
  <form method="get" class="mt-4">
    <input type="hidden" name="facility" value="{{ selected_facility }}">
    <input type="hidden" name="case_manager" value="{{ selected_case_manager }}">
    <input type="hidden" name="start_date" value="{{ selected_start_date }}">
    <input type="hidden" name="end_date" value="{{ selected_end_date }}">
    <input type="hidden" name="search_unique_id" value="{{ search_unique_id }}">
    <button type="submit" name="export" value="excel" class="btn btn-success w-100">
      Download Excel Report
    </button>
  </form>

</div>


{% endblock content %}






