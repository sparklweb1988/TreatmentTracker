@login_required
def track_vl(request):
    today = timezone.now().date()

    # ================== FILTERS ==================
    facility_id = request.GET.get("facility")
    selected_case_manager = request.GET.get("case_manager")
    start_date = request.GET.get("start_date")
    end_date = request.GET.get("end_date")
    unique_id = request.GET.get("unique_id")  # no 'None' check

    # Safe date parsing
    start_date_obj = None
    end_date_obj = None
    if start_date:
        try:
            start_date_obj = datetime.strptime(start_date, "%Y-%m-%d").date()
        except ValueError:
            pass
    if end_date:
        try:
            end_date_obj = datetime.strptime(end_date, "%Y-%m-%d").date()
        except ValueError:
            pass

    facilities = Facility.objects.all()
    refills = Refill.objects.all()

    # Apply filters
    if facility_id:
        try:
            refills = refills.filter(facility_id=int(facility_id))
        except ValueError:
            pass
    if selected_case_manager:
        refills = refills.filter(case_manager=selected_case_manager)
    if unique_id:
        refills = refills.filter(unique_id__icontains=unique_id)
    if start_date_obj:
        refills = refills.filter(vl_sample_collection_date__gte=start_date_obj)
    if end_date_obj:
        refills = refills.filter(vl_sample_collection_date__lte=end_date_obj)

    # ================== PAGINATION ==================
    paginator = Paginator(refills.order_by('-vl_sample_collection_date'), 10)
    page_number = request.GET.get('page')
    page_obj = paginator.get_page(page_number)

    # Case managers for dropdown
    case_managers_qs = (
        Refill.objects.exclude(case_manager__isnull=True)
        .exclude(case_manager__exact="")
        .values_list("case_manager", flat=True)
        .distinct()
    )
    case_managers = sorted({cm.strip() for cm in case_managers_qs if cm and cm.strip()})

    # Excel download
    if 'download' in request.GET:
        return export_vl_to_excel(refills)

    context = {
        "facilities": facilities,
        "selected_facility": facility_id,
        "case_managers": case_managers,
        "selected_case_manager": selected_case_manager,
        "selected_unique_id": unique_id,
        "selected_start_date": start_date,
        "selected_end_date": end_date,
        "refills": page_obj,
    }
    return render(request, "track_vl.html", context)
