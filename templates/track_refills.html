{% extends 'base.html' %}

{% block content %}
<style>
  .overdue { background-color: #f8d7da !important; }
  .cards-container { display: flex; flex-direction: column; gap: 1rem; }
  .refill-card { padding: 1rem; }
  .refill-card small { display: block; margin-bottom: 0.5rem; }
  @media (max-width: 767px) {
    .table-responsive { display: block; overflow-x: auto; -webkit-overflow-scrolling: touch; max-width: 100%; }
    .refill-card h5 { font-size: 1rem; }
  }
</style>

<h2>Refill Tracking</h2>

<!-- FILTERS -->
<form method="get" class="mb-3 d-flex gap-2 align-items-center">
  <select name="facility" onchange="this.form.submit()" class="form-select w-auto">
    <option value="">All Facilities</option>
    {% for facility in facilities %}
      <option value="{{ facility.id }}" {% if facility.id|stringformat:"s" == selected_facility %} selected {% endif %}>{{ facility.name }}</option>
    {% endfor %}
  </select>

  <select name="case_manager" onchange="this.form.submit()" class="form-select w-auto">
    <option value="">All Case Managers</option>
    {% for manager in case_managers %}
      <option value="{{ manager }}" {% if manager == selected_case_manager %} selected {% endif %}>{{ manager }}</option>
    {% endfor %}
  </select>

  <!-- Start Date Filter -->
  <input type="date" name="start_date" value="{{ selected_start_date }}" class="form-control w-auto">

  <!-- End Date Filter -->
  <input type="date" name="end_date" value="{{ selected_end_date }}" class="form-control w-auto">

  <button type="submit" class="btn btn-danger">Apply Filters</button>
</form>

<!-- MOBILE CARDS -->
<div class="d-block d-md-none cards-container">
  {% for period in periods %}
    {% with period_name=period.0 refills=period.1 %}
      <div class="card refill-card {% if period_name == 'Daily' %}text-white bg-primary{% elif period_name == 'Weekly' %}text-dark bg-warning{% else %}text-white bg-success{% endif %}">
        <div class="card-body">
          <h5>{{ period_name }} Refills ({{ refills.paginator.count }})</h5>

          {% for refill in refills %}
            <small {% if refill.next_appointment and refill.next_appointment < today %} class="overdue" {% endif %}>
              {{ refill.unique_id }} | {{ refill.facility.name }}<br>
              {{ refill.next_appointment }} | {{ refill.current_regimen }}<br>
              Case Manager: {{ refill.case_manager }}
            </small>
            <hr>
          {% empty %}
            <small>No {{ period_name|lower }} refills</small>
          {% endfor %}

          <!-- Pagination -->
          {% if refills.has_other_pages %}
            <nav>
              <ul class="pagination pagination-sm">
                {% if refills.has_previous %}
                  <li class="page-item">
                    <a class="page-link" href="?{{ request.GET.urlencode }}&{{ period_name|lower }}_page={{ refills.previous_page_number }}">«</a>
                  </li>
                {% endif %}
                <li class="page-item disabled"><span class="page-link">Page {{ refills.number }} of {{ refills.paginator.num_pages }}</span></li>
                {% if refills.has_next %}
                  <li class="page-item">
                    <a class="page-link" href="?{{ request.GET.urlencode }}&{{ period_name|lower }}_page={{ refills.next_page_number }}">»</a>
                  </li>
                {% endif %}
              </ul>
            </nav>
          {% endif %}

        </div>
      </div>
    {% endwith %}
  {% endfor %}
</div>

<!-- DESKTOP TABLES -->
<div class="d-none d-md-block">
  {% for period in periods %}
    {% with period_name=period.0 refills=period.1 %}
      <h3>{{ period_name }} Refills ({{ refills.paginator.count }})</h3>
      <div class="table-responsive">
        <table class="table table-striped table-bordered">
          <thead class="table-dark">
            <tr>
              <th>Unique ID</th>
              <th>Sex</th>
              <th>Facility</th>
              <th>Last Pickup</th>
              <th>Refill (Days)</th>
              <th class="text-danger">Next Appointment</th>
              <th>Regimen</th>
              <th>Case Manager</th>
            </tr>
          </thead>
          <tbody>
            {% for refill in refills %}
              <tr {% if refill.next_appointment and refill.next_appointment < today %} class="overdue" {% endif %}>
                <td>{{ refill.unique_id }}</td>
                <td>{{ refill.sex }}</td>
                <td>{{ refill.facility.name }}</td>
                <td>{{ refill.last_pickup_date }}</td>
                <td>{{ refill.months_of_refill_days }}</td>
                <td>{{ refill.next_appointment }}</td>
                <td>{{ refill.current_regimen }}</td>
                <td>{{ refill.case_manager }}</td>
              </tr>
            {% empty %}
              <tr><td colspan="8" class="text-center">No {{ period_name|lower }} refills</td></tr>
            {% endfor %}
          </tbody>
        </table>

        <!-- Pagination -->
        {% if refills.has_other_pages %}
          <nav>
            <ul class="pagination">
              {% if refills.has_previous %}
                <li class="page-item">
                  <a class="page-link" href="?{{ request.GET.urlencode }}&{{ period_name|lower }}_page={{ refills.previous_page_number }}">«</a>
                </li>
              {% endif %}
              <li class="page-item disabled"><span class="page-link">Page {{ refills.number }} of {{ refills.paginator.num_pages }}</span></li>
              {% if refills.has_next %}
                <li class="page-item">
                  <a class="page-link" href="?{{ request.GET.urlencode }}&{{ period_name|lower }}_page={{ refills.next_page_number }}">»</a>
                </li>
              {% endif %}
            </ul>
          </nav>
        {% endif %}
      </div>
    {% endwith %}
  {% endfor %}
</div>

<br><br>
<a href="{% url 'track_refills' %}?download=true&facility={{ selected_facility }}&case_manager={{ selected_case_manager }}&start_date={{ selected_start_date }}&end_date={{ selected_end_date }}" class="btn btn-success">Download Track Refills as Excel</a>
<br><br>

{% endblock %}
